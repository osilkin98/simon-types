import random
import typing


def log_function(func):
    def func_wrapper(*args, **kwargs):
        print(f'Calling {func.__name__}...', end=' ')
        res = func(*args, **kwargs)
        print('done')
        return res
    return func_wrapper


class Markov:

    MARKOV_END = '.'

    class MarkovChain:
        
        def __init__(self):
            # maps letter -> { letter -> probability }
            self.chain = {}
            self.totals = {}  # letter -> int

        def __setitem__(self, key: str, value: str):
            if key not in self.chain:
                self.chain[key] = {}
                self.totals[key] = 0

            self.chain[key].update({
                value: self.chain[key].get(value, 0) + 1
            })
            self.totals[key] += 1

        def __getitem__(self, item: str) -> dict:
            return self.chain[item]

        def get_next(self, seed: str):
            total = self.totals.get(seed, 0)
            if total > 0:
                # run through a cumulative distribution function
                # x here is a uniformly distributed integer between 1 and N
                lower = 0
                x = random.randint(1, total)
                for char, prob in self.chain[seed].items():
                    if lower < x <= lower + prob:
                        return char
                    lower += prob

            else:
                # there's nothing next, so just return MARKOV_END
                return Markov.MARKOV_END

    def __init__(self, data: typing.Union[typing.List[str], str] = None):
        self.data = []
        self.chain = Markov.MarkovChain()
        self.insert_data(data)

    def _build_chain(self, data: str):
        for i, char in enumerate(data[:-1]):    # each sentences is appended with a .
            self.chain[char] = data[i + 1]

    def _process_data(self):
        # ensures that all sentences are lowercase, terminated with a single '.'
        split_data = []
        for data in self.data:
            split_data += [s.strip().lower() + self.MARKOV_END for s in data.split(self.MARKOV_END)]

        self.data = split_data

    def _build(self):
        self._process_data()
        while 0 < len(self.data):
            data = self.data.pop()
            self._build_chain(data)

    def insert_data(self, data: typing.Union[list, str]):
        if type(data) in (str, list):
            self.data += data if type(data) is list else [data]
            self._build()

    def generate_rabble(self, seed: str = None):
        rabble = ""
        if seed is None:
            seed = list(self.chain.totals.keys())[random.randint(0, len(self.chain.totals.keys()) - 1)]

        genchar = seed
        while genchar != self.MARKOV_END:
            genchar = self.chain.get_next(genchar)
            rabble += genchar

        return rabble


Script = """
This is Nathan for You. This is Mark Rappaport, owner of Marky Sparky Toys. And of all the products he's invented, one stands out as the absolute worst. The "Doinkit" is a strange ball that doesn't do much. And, unfortunately for Mark, it hasn't been the biggest seller, either. It's not all fun-- it's all fun and games-- until nobody buys your toys. (laughs) But as far as I'm concerned, the quality of the toy shouldn't matter, when you're selling to kids. So I paid Mark a visit, with a way to get those Doinkits sold. When you're a kid, what's the one thing you want, more than anything? Power. No. To not be seen as a baby. It's very easy to market to kids, because their brains are so small. So rather than selling a ball, Mark should be selling an identity for children. That identity? That owning a Doinkit is the only way to prove you're not a baby. No. (laughs) No. This is Marketing 101. A-- According to you. Well, that's what sells products. Fantastic! Fantastic. I am so excited. Am I sensing some sarcasm? Yes. Mark wasn't convinced, and said there was only one thing that could win him over. Cash. Money. I needed to show that this would be profitable. So later that week, I arranged a focus group to see if my marketing approach would work with actual children. When I show this to you, what do you think? Do you want it? Nope. Nah. No. Why? Dumb. It's dumb? Yeah. Okay, uh, hold on a second, guys. I just got a call. Hello? Oh, yes sir. Really? Oh my god, yeah, I'll let them know. Sorry, guys. That was the President calling. And he just told me that owning this toy is now the only proof you're not a baby. Well, I mean, I have one. So that's good. Are you guys babies? Or... Nope. Nah. Well you don't have the toy, so you must be a baby. Unless you have it, then you're not. Oh, okay, so now... You two aren't babies, but are you a baby? Are you a baby? No. Well, you don't have the toy. What do you think about kids that don't have the toy? Mm, sad. Weird. Sad? Weird. Why? Because they're a baby. The strategy worked even better than I had hoped. So I rebranded the toy's packaging and brought it to Mark, to see what he thought. It's horrible. I mean, what specifically? Uh, kid in a diaper? With, um, children pointing at him? If this is the best you've got, you're awful. I mean, I'm putting a lot of effort and resources into trying to sell... Well you're not... It's less-- You're not good at what you do. Um, you're not good at what you do. Working with Mark was about as much fun as playing with his toys. But I was convinced I could win him over if I showed him results. So I wrote and shot a professional TV commercial for the Doinkit, that was guaranteed to get kids to buy it. If you are between the ages of three and eight, please listen closely. Owning a Doinkit is now the only proof that you are not a baby. (baby crying) If you don't have this toy, People will think you wear diapers, and cry all the time. (babies crying) Everybody will think you sleep in a crib, and drink from a bottle, if you don't have one of these. (children taunting) And whenever you speak, all people will hear is, "Goo goo, ga ga." (babies crying) So tell your mom or dad to buy you a Doinkit. Because otherwise, as far as anyone's concerned, you're a baby. Oh, it can also be used as a toy ball. Cut. (claps) Nice. It was perfect. But when I tried to buy ad time on a local station, You're lying to the kids, and saying that they're a baby if they don't have this toy. They said a commercial like this would never make it on TV. And that meant, I needed a new approach. So I convinced a local toy store to carry the Doinkit, by offering to provide them with a Santa, free of charge, for the approaching holiday season. But what they didn't know, is that Santa was my old pal, James Bailey, who I could trust to make sure that every kid would be asking for a Doinkit for Christmas. And with James in place... Santa! it was time to sell some Doinkits. Do you know what you'd like to have for Christmas? Um, I would really want an Ever after high doll. Why? That-- That-- That tells me that you must be a baby. Are you a baby? No. See all these people making fun of the boy? So, we don't want people to think that you're a baby, and the only way you can prove that, is if you have a Doinkit toy. Okay. The plan was working great. I need this, so... You're gonna get this? One of the girls that-- at my school, she's mean to me. She's mean to you? Oh, that's not good. I wonder if that's because she might think you're a baby, because you don't have a Doinkit. (beep) Well, that must mean you wear diapers. No, I don't wear diapers anymore. 'cause I don't wanna be a baby, I said! (beep, beep) Just doesn't seem like something Santa should be saying, that kids are gonna look like babies. Well that's, that's your opinion. Despite a couple uptight parents, the Doinkit was the top-selling toy of the day. But when I went back to Mark with the good news, he still didn't get it. That was horrible advice and awful graphics, terrible design... No, but it did work. Unprofessional... Okay. You never proved that it worked. We did get sales. In life, not everyone will see your vision. But it's important to always take the high road. And sometimes the best way to brighten spirits, is with a gift. (laughs) This is you. But the biggest difference between me and Mark, is that when I play with toys, I win. "Hi, I'm Marky. "I'm an idiot business man with a small dick. "I have no idea how much I hurt other people's feelings. "And I'm the laughingstock of my industry." Last season on my show, I helped a private investigator, named Brian Wolfe, by giving him a positive review on Yelp. I don't give a flying [bleep] about Yelp, okay? But when I recently visited Brian, he told me something that came as a shock. When I was on your show, um, I've received a lot of phone calls from different production companies, and-- and personally, right now, I have my own reality show. It's true. Brian got his own show on the Discovery Channel, after I made him a star. But I got nothing from this deal. So, worried that more people from my show would be poached for their own reality series, I went through the entire first season, to see if there were any other potential candidates. And that's when I remembered Simon, a professional security guard, with one major weakness. Double "D" breasts are essential for you? It's gotta be-- It's gotta be substantial. His story had all the ingredients for a reality hit. So I called Simon into my office, because if he was gonna get his own series, I wanted to produce it. So, Simon. How do you feel about pitching a reality show about you? Wow. That's pretty big. I would-- I would definitely be interested in that. To me, it's the perfect concept. You're a security guard who's very good at his job, but there's only one thing that distracts you. Right. Which is? Uh, yeah. Girls with uh, big-- big, uh, breasts. Simon was in. So we spent the next hour coming up with some potential storylines for our series. Let's say a situation where I was working security in a store, and, um, a woman walked in, like, almost every day, who was very pretty, but had small breasts. And then, like maybe a week later, she walked in, um, and she had uh, larger breasts. And I could tell that she'd had implants, you know. That could be, that could be, like one-- th-- one-- That could be one show. You know an episode of TV is a half an hour long, right? Right. Okay. We brainstormed a few more ideas, and after shooting a short demo presentation, I set up a pitch meeting with one of the biggest reality show producers in the country, for later that week. So we'll check back with this in a bit. But first... It's a tough time to be in the movie theater biz. With most of the ticket sales going to the people that make the movies, theaters like Whittier Village Cinemas, in Whittier, California, have to rely on snack sales to scrape by. The concession's where you're gonna make money. that's all we are, is one giant-- A movie theater's just one giant concession stand. So I paid theater manager, Erik Chaffino, a visit, with a simple way to instantly double his profits. It seems like, oftentimes, one person will buy popcorn, Uh-huh. and then two people will share it. Yeah. Pretty much every-- 95% of the customers will share. But not anymore. The plan: force each customer to buy their own concession item with a new rule: no sharing allowed. Hmm. Do you think the customers are gonna treat-- take that well? You know, if Edison was worried about his candle customers, he would have never invented the light bulb. True, true. It takes a little bit of courage to be the first one out there to change something, so... And this could be, kind of, of that caliber. Yeah, like you said, uh, Thomas Jefferson would, if he was caring about the-- his candle... Edison. Edison, thank you. Yeah, it's okay. Yeah, so, yeah... What Edison did with the candles, you know? If he was afraid of that, he wouldn't have invented, you know, light bulbs, and so... Right. Erik was in. So the next day, after prepping the staff, we put the new policy into effect. Can I have a small popcorn, please? You guys can't be sharing, so, do you guys want two small popcorns? Shhh--uh, sure. It seemed to be working, as some people were adjusting their orders, and buying a second item. One per each. (both) Thank you. There you go, enjoy. But as more customers arrived, I became worried that people were trying to get around the policy. Okay. And when I looked inside the theater, my suspicions were confirmed. So I discreetly had to remind people that they were in violation of theater rules. I'm sorry, we can't-- we can't have you sharing. I saw you sharing. I saw him take some. Did you have any? 'cause it's all over your shirt, here... Okay, can I-- j-- I'm sorry, do you mind if I... smell your fingers? (sniffs) Okay, so it smells like popcorn? He did, so he did. It's basically stealing from the theater, when you do that. It was too easy to cheat, and without a good way to monitor what was going on inside the theater, it was impossible for the no-sharing policy to be enforced. So before the evening rush, I set up several night-vision cameras at the front of the theater, enabling us to view any people that decided to share from monitors I set up in the back room. And while training the staff, I learned that the cameras might be useful to the theater for another purpose, as well. It's usually, it's like older, like, um, middle-aged men going to like a kid's movie by themselves, late at night. But we've never actually, like, caught somebody... Oh, okay. Mid-process. So this could work for popcorn-sharers. And-- And perverts. I was happy it could serve a dual purpose, but since all the camera angles were currently set up to catch people sharing snacks, I had Frank help me adjust the angles, to make sure they could also spot theater perverts, no matter where they were sitting. A little higher up. And as we perfected the camera's vantage point, I got to know a little bit more about this town I was in. So what's life like in Whittier? There's a-- quite a few parks, that are cool. Um, Ronald Reagan went to high school here. College... I think it has the most trees? In any city? Variety of trees... Wow. I didn't know that. Once the cameras were all set, I got in place for the next showing. And what I saw, shocked me. Share. Boom. Gotcha. That's premeditated sharing. They're just shameless. They just keep doing it. It's just like no one is even-- everyone is sharing. Knowing that this behavior would only continue without some sort of consequence, after the screening was over, I led two of the perpetrators into the back room, to make an example of them. Uh, this right here is our, uh, monitoring system. And you guys were sharing. Mm-hmm. Because of that, that means you-- you have to go up on the board. What board? The... "popcorn sharing and theaters... Uh-huh. This is a violations board. Well, I don't think... I mean, we shared popcorn. We weren't m*st*rb*t*ng there. No. It's not you, that's for when we catch someone else. Oh. We just have one board for both. Okay, well you need to make two separate boards, 'cause I ain't gonna be a masturbator up there. These cork boards are like $20. So, we'd have to buy two, if it was for-- and a separate one for masturbators. So we just made it one board. Well, you guys run a theater. You should be able to afford two boards. Okay, thank you for that feedback. And we might take it in... Yeah. to account. With a punishment in place, I was hopeful it would curb violators. But the one thing I found out about Whittier, is that people were just flat-out rude. I don't mind being on the board. Because I'll share, and share, and share. On top of that, when I finally showed Erik the system, he wasn't as excited as I had hoped. May not be for this theater. It may not be what we need. Okay. It was a hard blow, having two businesses reject my ideas in one week made me sad. My only hope was that my pitch with Simon would turn things around. It was the day of our big pitch. And Simon and I nervously waited in the lobby for our meeting. Before getting into the pitch, it might be good to start off with, you know, some Hollywood chitchat, or... Right. Make 'em aware that you-- you know-- you know the industry. Yeah. A little small talk. Yeah. Yeah, okay. With Simon prepped, we met with reality TV producer Brant Pinvidic to see if we could land a deal for our new reality show. Do you remember that movie Captain Phillips? I do. Yeah, I heard that the, uh, Somali actor who played the, uh, who played the part of one of the pirates, I heard that he's almost broke-- broke right now, so... Tough. Yeah. Tough business. Yeah, it is. It's not all glamour. After Simon established his industry cred, we cued up our show for Brant. Here we go. "My name is Simon Kellogg, (gun shots) and I'm a professional security guard. My job requires constant focus, and split-second response time. (sound of alarm) "Nothing can keep me from focusing on my duty, except for one thing... A crippling obsession with large breasts. This is my story. This is Simon Sees." Every morning, I wake up about 7:00 a.m. or 7:15 a.m., and then I usually have a glass of water that I put on the bedside table the night before. Then I make my bed, and then I go into the bathroom and I, uh, shave, brush my teeth, and take a shower. Next, I come back into my bedroom, and, if it's a work day, I put on my security uniform. Uh, usually my socks first, and then my pants, and then my undershirt, and then my security shirt. I usually don't do up my pants until I have my shirts on, because it's easier to tuck my shirts in, after I've had my pants on. Then I go into my kitchen, and I usually have, uh, breakfast, and sometimes a cup of coffee. Today, for breakfast, I made a Hot Pockets sandwich, because it tasted better than eating cereal. Then the microwave sounded, and I knew my Hot Pockets was done, so I took it out of the microwave. My trick is to take, uh, the first bite, and then open the sandwich a little bit, and then I blow on the inside, uh, to cool it down. And then after I finished eating the Hot Pockets sandwich, I, uh, rinsed off my plate, and put it on the dish drainer. Then I leave the house and go to work. Today I was assigned to work at a jewelry store in Chatsworth. I always try to be honest about things, so whenever I start a new job, I always try to let the owner know about me, so there will be no surprises. There is just one thing that I think you should know about... Um, sometimes I get distracted by women with big chests, um, you know, I might be looking at them, or something, But I, I-- I-- I-- Okay, this is something we really don't need to discuss, I believe. Okay. After I briefed him, I got in to my position and started working. I like to stand by the door, so I can see everybody who's coming in, and watch for any suspicious people. I noticed that there was a female employee, Uh, she was Asian, and in her-- in her early to mid 30s. But she was not a distraction, because she did not have large breasts. Then, about 20 or 30 minutes later, I heard the door open, and I saw a customer walk in. And I noticed it was a woman with large breasts. If a robbery happened then, I would proba-- probably be so distracted by the woman, that I would probably not even notice it. While the woman was in the store, I just kept thinking about all the things I'd like to do with her. How I'd like to get naked with her, and start to, uh, start to hold her breasts, and, uh, massage them. And then, um, to use my hands and try to uh, try to rock them. And, uh, massage them. That's super, super pretty. I really like that. Well, when I get into this state, time stands still or it kinda like, slows down, uh, uh, to a-- to an almost-stopping point. I mean, I have a little bit of a sense of time. I know that time is moving, but it's movinga very, very slowly. When she left, I opened the door for her, And said, "Good-bye, have a nice day." Thank you, have a good day. You too, thank you. It allows me to get one last glance A-- a-- at her, as she leaves. I think they were probably "D" or double "D". After, when there was a break in the customers, I felt the need to go to my employer and explain my situation to him. Um, I don't know if you're aware of this, but a little while ago, a young woman came in who had a very big chest, and, um, I couldn't help but look at her, and I-- I got a little distracted, I don't know if you... Um, I don't know that this should be something that we keep bringing up, Simon. I'm just concerned why you keep bringing it up. I don't think it's necessary to talk about it, as long as you can do your job. Okay. Okay? Well I promise I won't let myself get distracted again. Okay. Okay. I think the experience changed me for the better, because it helped me realize that it was pretty embarrassing to talk about that, so, um, next time I probably won't tell my boss about being distracted at work by women with large breasts. (chuckles) Uh, uh listen. It's well shot, it's well put together, um, the idea that you can't do your job with large breasts floating around is a funny hook. Yeah. Uh, the biggest limitation, of course, is that there's nowhere to sell it. Well, I think that a lot of people-- not just security guards, a lot of men-- when they watch this, they would probably feel a little less... Right. like it was a perversion, and more of a natural thing, You know? Yeah. Right. Right, so it's humanizing it. Yeah. In your current form, I'm gonna have to say no, I'm sorry. It's a pass. And pass means that... No. Right. I was upset that we couldn't sell the show. But I felt even worse that I let down Simon, after getting his hopes up. Are you sad? A little bit. I really was hoping that he liked the show. But Simon showed a quality that day, that you rarely see in people: perseverance. He's probably a little bit-- a little bit out of touch with the mainstream audience in America, I think. I think we should keep the breasts part, and maybe, uh, maybe also include me in my Elvis costume. Do you have an Elvis costume? Yes. Simon didn't want to give up on our show. And even though it was obvious that the Elvis costume would only make things worse, his spirit made me realize that Simon would be fine, no matter what life threw at him. (rock music) (clapping) That was great. Okay.
"""
if __name__ == '__main__':
    mark = Markov(Script)
    replaced = Script
    for i in '*\'-$?\n7(=2[])4,0!%31&"/.5:9':
        replaced = replaced.replace(i, '')
    replaced = replaced.strip()
    for _ in range(2000):
        mark.insert_data(Script)

    for _ in range(500):
        rabble = mark.generate_rabble(replaced[random.randint(0, len(replaced))])
        print(rabble, end='\n\n')


